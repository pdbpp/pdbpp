dist: xenial
language: generic
cache: false

env:
  global:
    - PYTEST_ADDOPTS="-vv --cov-report=xml:coverage-travis.xml"
    - PIP_DISABLE_PIP_VERSION_CHECK=true

stages:
  - name: test
    if: tag IS NOT present
  - name: release
    if: tag IS present

jobs:
  include:
    - name: Windows
      os: windows
      language: shell
      before_install:
        - python --version
        - choco install --no-progress python --version 3.8.0
      env:
        - PATH=/c/Python38:/c/Python38/Scripts:$PATH
        - TOXENV=uses_custom_script
        - PYTEST_ADDOPTS="$PYTEST_ADDOPTS --cov-append"
      script:
        - python -m tox -e py38-coverage --force-dep="pytest @ git+https://github.com/blueyed/pytest.git@colorama"
        - c:/users/travis/build/pdbpp/pdbpp/.tox/py38-coverage/scripts/python.exe t_windows.py
        # Test without colorama (re-use same toxenv for performance reasons).
        - .tox/py38-coverage/Scripts/python.exe -m pip uninstall -y colorama
        - c:/users/travis/build/pdbpp/pdbpp/.tox/py38-coverage/scripts/python.exe t_windows.py
        - python -m tox -e py38-coverage

    # - name: 'py37 (osx)'
    #   os: osx
    #   osx_image: xcode10.2
    #   env: TOXENV=py37-coverage
    #   before_install:
    #     - ln -sfn "$(which python3)" /usr/local/bin/python
    #     - python -V
    #     - test $(python -c 'import sys; print("%d%d" % sys.version_info[0:2])') = 37
    #
    # - name: 'py36 + py35 + py34 + py27'
    #   env:
    #     - TOXENV=py34-coverage,py35-coverage,py36-coverage,py27-coverage
    #     - INSTALL_PYTHON="python-3.5 python-3.4"
    #
    # - name: 'py38 + py37 + checkqa'
    #   env:
    #     - TOXENV=py38-coverage,py37-coverage,checkqa
    #     - INSTALL_PYTHON="python-3.8"
    #
    # - name: 'pypy3 + pypy'
    #   env:
    #     - TOXENV=pypy3-coverage,pypy-coverage
    #     - INSTALL_PYTHON="pypy pypy3"

    - stage: release
      name: 'release'
      python: '3.7'
      script: skip
      install: skip
      deploy:
        provider: pypi
        user: "__token__"
        password:
          secure: "K7aCzKbiKqPhXhueB8OBl+6uu6Z7iQeKBircMmK6Et7oXhAkaQk28lboLBtpVhCEm0D2rWQnhoEVMUKsQ76FdX+kmBzGaQw4sU7v41gDo3IyD/oozoWeni26GRjWNbznulOd8SE9n2qjSXNihDAeWDFLELPNulvLWfmB/hCR8d8XHurZSmbV1Wu/553ULAMCmjowZLMskR5Y2HjdIkGdTzj3lCLcMdstWS3bxvq8YpJRM8KOGWs9I2D1dac2M5IrDDVmlG+0scvn9cqilB4vGEZm+HsWLHJvQBJ6J7GaQBVI2KcHiytu2fwcvXxSdJXB/Rx2WftwWnb0tAQQ0/I0CmgCBwn8y8cPmTAQ6QP1wlXl8LLYIzuzki1PSGYmWSo0Ztg6Zwls5EqOOiSspCAjVwtYZKsA7JLz60GA4FDuoUvT5aJhZ+QF/t5lEsm/QMWke5CxlayzRXU/Y9Yt6WynX+DSEAF8oHV9FIsdxODxp8q92QLMaNIQHMUgIh02Cu/RZ45ImRKUNDTh1h5UE0kla1htAt31V/w43uJGWRNj7lYrt56iR6uikFsgAYwwMOOIBmP95ilRttSAikX/O+AjGgdj1/J95hZtL9lCxCcy6iXlN9Wk/oj59r64wXYKgbU74PHorN2EEZQf3iLkfW7x1L3HZkg05tBkc+bzBluO0Dk="
        on:
          tags: true
          distributions: 'sdist bdist_wheel'
          repo: pdbpp/pdbpp

before_install:
  - |
    if [ -n "$INSTALL_PYTHON" ]; then
      set -x
      for v in $INSTALL_PYTHON; do
        url="https://storage.googleapis.com/travis-ci-language-archives/python/binaries/ubuntu/16.04/x86_64/$v.tar.bz2"
        curl -sSf --retry 5 ${url} | sudo tar xjf - --directory /
      done
      set +x
    fi
    for v in /opt/python/*/bin; do
      echo "Adding to PATH: $v"
      PATH="$v:$PATH"
    done

install:
  - python --version
  - python -m pip install --user tox==3.13.2
  # NOTE: need to upgrade virtualenv to allow "Direct url requirement" with
  # installation in tox.
  - python -m pip install --user virtualenv==16.7.3

before_script:
  - python -m pip --version
  - python -m pip freeze

script:
  - python -m tox --force-dep="pytest @ git+https://github.com/blueyed/pytest.git@my-master;python_version>='3.5'"

after_script:
  - |
    if [[ "$TOXENV" != checkqa ]]; then
      python -m coverage report -m
      # Unset TRAVIS_CMD to work around https://github.com/codecov/codecov-bash/issues/174.
      env -u TRAVIS_CMD bash <(curl -s https://codecov.io/bash) -Z -X gcov -X coveragepy -X search -X xcode -X gcovout -X fix -f coverage.xml -n "${TRAVIS_PYTHON_VERSION}" -F "${TRAVIS_OS_NAME}"
    fi

branches:
  only:
    - master
    - /^\d+\.\d+(\.\d+)?(-\S*)?$/
